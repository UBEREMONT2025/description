# План разработки архитектуры Уберемонт

Ниже пошаговый план разработки архитектуры на основе текущего HLA.
Подход итеративный: каждый шаг завершаетcя понятными артефактами,
которые согласуются с бизнесом и командами.

## 1. Уточнение рамок и целей
**Что делаем:**
- фиксируем цель платформы и метрики успеха;
- определяем стейкхолдеров и зоны ответственности;
- уточняем регуляторные и юридические требования.

**Результат:** согласованные рамки, предпосылки, КПИ.

**Вопросы:**
1) Какая целевая география (город/регион/страна)?
2) Нужны ли юридически значимые ЭП уже в МВП?

## 2. Приоритизация ключевых сценариев (МВП и следующие волны)
**Что делаем:**
- фиксируем 5–7 ключевых сценариев МВП;
- определяем, что точно не входит в МВП;
- задаем минимально нужные статусы и данные.

**Предлагаемые сценарии МВП (включая тендеры):**
1) Лид -> сделка -> заявка.
2) Онбординг заказчика и доступ в личный кабинет.
3) Дизайн‑проект: тендер на дизайнера -> договор -> старт.
4) Дизайн‑проект: этапы -> согласование -> акты.
5) Ремонт: тендер на управляющего -> договор -> базовый бюджет.
6) Ремонт: этап -> акт -> приемка/замечания.
7) Оплата по этапам -> синхронизация с 1С.

**Результат:** матрица приоритетов сценариев и границы МВП.

**Вопросы:**
1) Подтверждаем полный дизайн‑проект в МВП или только тендер+договор?
2) Нужны ли в МВП закупки/логистика, или оставить на следующий этап?

**Решения:**
- МВП включает полный дизайн‑проект: тендер -> договор -> этапы -> акты.
- Закупки и логистика вынесены на следующий этап (не входят в МВП).

## 3. Доменная модель и словарь терминов
**Что делаем:**
- описываем сущности, связи, статусы и жизненные циклы;
- фиксируем единые идентификаторы и владельцев данных (источник правды).

**Результат:** доменная модель, словарь терминов, владельцы данных.

**Вопросы:**
1) Какие сущности считаем обязательными: проект, этап, акт, платеж, договор?
2) Где «источник правды» по проекту и этапам: Битрикс или веб‑контур?

**Решения:**
- Источник правды по проекту и этапам: Битрикс24.
- Обязательные сущности МВП: Лид/Сделка, Проект, Клиент, Дизайн‑этап, Акт,
  Договор, Платёж, Тендер, Отклик, Участник проекта.
- Оплаты по акту допускают частичные платежи: предоплата 50% и постоплата 50%.

**Черновик доменной модели и словаря терминов (МВП):**
**Сущности и краткие определения:**
- **Клиент** — заказчик проекта; контактные данные, история взаимодействий.
- **Лид/Сделка** — коммерческая сущность воронки; фиксирует интерес, стадию и
  условия, из сделки создается проект.
- **Проект** — единая сущность, связывает участников, этапы, документы и оплаты.
- **Участник проекта** — связка «проект + роль» (заказчик, ПМ, дизайнер,
  управляющий); определяет права и доступ.
- **Тендер** — конкурс на подбор исполнителя (дизайнер/управляющий).
- **Отклик** — предложение участника на тендер с условиями и комментариями.
- **Дизайн‑этап** — стадия дизайн‑проекта (планировка, концепция и т.д.).
- **Договор** — юридическая фиксация условий (дизайнер/управляющий).
- **Акт** — документ приемки этапа или финала (подписывается сторонами).
- **Платёж** — финансовая операция, связанная с актом/этапом; возможны частичные
  оплаты по одному акту.

**Связи (минимум для МВП):**
- Клиент 0..N Лидов/Сделок.
- Лид/Сделка 0..1 Проекта (после квалификации).
- Клиент 1..N Проектов.
- Проект 1..N Участников проекта (по ролям).
- Проект 1..N Тендеров (дизайнер, управляющий).
- Тендер 1..N Откликов.
- Проект 1..N Дизайн‑этапов.
- Дизайн‑этап 1..N Актов (черновой/итоговый).
- Проект 1..N Договоров.
- Акт 1..N Платежей (частичные оплаты 50/50 в МВП).

**Решения по уточнениям:**
- Сущность «Лид/Сделка» включаем в доменную модель (не только статусы).
- Допускаем несколько оплат на один акт (50% предоплата, 50% постоплата).

## 4. Контекстная архитектура (диаграмма С4, уровень 1)
**Что делаем:**
- обозначаем границы системы и внешних участников;
- фиксируем внешние системы и каналы.

**Результат:** контекстная диаграмма С4.

**Вопросы:**
1) Есть ли внешние системы кроме Битрикс и 1С (телефония, банки, СДЭК)?

**Решения:**
- Внешние системы присутствуют: электронная подпись, Wazzup, телефония,
  банковские сервисы, email‑сервисы, SMS‑шлюзы.

**Вопросы для уточнения:**
1) Какие именно провайдеры ЭП, банка, email и SMS?
2) Через что идет Wazzup (API/вебхуки) и для каких каналов?

**Статус:** ответы отложены, зафиксировать позже при выборе провайдеров.

## 5. Контейнерная архитектура (диаграмма С4, уровень 2)
**Что делаем:**
- описываем контейнеры: веб, БФФ, Битрикс24, 1С, интеграционный слой, ИИ;
- фиксируем ответственность и интерфейсы между контейнерами.

**Результат:** контейнерная диаграмма С4 и список интерфейсов.

**Вопросы:**
1) Будет ли отдельный сервис очередей/интеграций или все в БФФ?

**Решения:**
- Отдельный сервис интеграций не выделяем: все интеграции и очереди в БФФ
  (Laravel/CURSOR).

## 6. Оркестрация процессов (BPMN / статусные машины)
**Что делаем:**
- описываем маршруты и переходы для ключевых процессов;
- фиксируем правила откатов, блокировок и эскалаций.

**Результат:** BPMN или статусные схемы по 5–7 процессам.

**Вопросы:**
1) Кто окончательно подтверждает этапы: заказчик или ПМ?
2) Как фиксируются «замечания» — как отдельный процесс или статус?

**Решения:**
- Окончательное подтверждение этапов выполняет ПМ.
- Замечания оформляются как отдельный процесс с отдельной сущностью.

## 7. Интеграционная архитектура (АПИ/вебхуки, синхронизация)
**Что делаем:**
- описываем контракты АПИ, события и вебхуки;
- задаем правила синхронизации, повторов и обработки ошибок;
- фиксируем маппинг данных между веб, Битрикс и 1С.

**Результат:** спецификация интеграций (АПИ, события, маппинг).

**Вопросы:**
1) Какие операции должны быть строго синхронными (например, оплата)?
2) Сколько допустимо задержки между системами?

**Решения:**
- Режим синхронизации: WEB ↔ Битрикс24 до 10–30 сек, Битрикс24 ↔ 1С до 1–5 мин.
- Строго синхронные операции: оплата, подписание актов, подписание договоров.

**Черновик синхронизации сущностей (МВП):**
- **Клиент:** WEB → Битрикс24 (регистрация), Битрикс24 → WEB (обновления),
  Битрикс24 → 1С (контрагент).
- **Лид/Сделка:** WEB → Битрикс24 (создание/изменение), Битрикс24 → WEB
  (стадии, статус).
- **Проект/участники проекта:** Битрикс24 → WEB (статусы, роли),
  Битрикс24 → 1С (ID проекта, бюджетные атрибуты).
- **Тендер/отклик:** WEB → Битрикс24 (публикация/отклик),
  Битрикс24 → WEB (выбор, статусы).
- **Дизайн‑этапы/акты:** WEB → Битрикс24 (загрузка, комментарии),
  Битрикс24 → WEB (статусы и решения),
  Битрикс24 → 1С (акт как триггер оплаты).
- **Замечания:** WEB → Битрикс24 (создание/обновление),
  Битрикс24 → WEB (статусы).
- **Платежи:** 1С → Битрикс24/WEB (статусы оплат),
  Битрикс24 → 1С (основание оплаты/акт).
- **Документы:** Битрикс24 → 1С (реквизиты/условия договоров),
  1С → WEB (закрывающие документы).
- **Коммуникации:** WEB/Битрикс24 → BFF → Wazzup/Email/SMS/телефония,
  обратные события → BFF → Битрикс24/WEB.

## 8. Архитектура данных
**Что делаем:**
- описываем схемы данных по контурам;
- определяем хранение файлов и историю изменений;
- задаем политику бэкапов.

**Результат:** ER‑модель, словарь данных, политика хранения.

**Вопросы:**
1) Где будем хранить файлы (локально, S3‑совместимое, другое)?
2) Нужен ли отдельный архив для закрытых проектов?

**Решения:**
- Файлы МВП храним в Битрикс.Диск.
- Срок хранения файлов: 3 года.
- Доступ к файлам в WEB: прямые ссылки Битрикс.Диск (для МВП).
- Офлайн‑доступ: предзагрузка файлов по запросу пользователя, только для
  объектов с подписанными договорами.
- Оценка объема на объект: до 1,2 ГБ (12 крупных схем).
- Форматы файлов: PDF, DWG, изображения.
- Лимит размера одного файла в МВП: до 100 МБ.

**Примечания по офлайн‑доступу:**
- В WEB без интернета нельзя получать новые файлы; возможен только доступ к
  ранее загруженным и сохраненным локально (кеш/PWA/скачивание).

**Решения по уточнениям:**
- Дополнительные форматы нужны: DOCX, XLSX.

## 9. Безопасность и РБАК (ролевая модель)
**Что делаем:**
- описываем роли и права доступа;
- фиксируем аудит критичных действий;
- задаем методы аутентификации.

**Результат:** модель доступа и список контролей.

**Вопросы:**
1) Какой способ входа: телефон+СМС, почта, комбинированный?
2) Требуется ли КЭП/УЭП для актов в МВП?

## 10. Нефункциональные требования и наблюдаемость
**Что делаем:**
- фиксируем требования по скорости и нагрузке;
- описываем мониторинг, метрики, алерты.

**Результат:** матрица НФТ и план наблюдаемости.

**Вопросы:**
1) Какой целевой SLA на МВП?
2) Какая пиковая нагрузка по заявкам в день?

## 11. Развертывание и ДевОпс
**Что делаем:**
- описываем окружения (dev/stage/prod);
- фиксируем процесс релизов и откатов;
- задаем правила хранения секретов и бэкапов.

**Результат:** схема развертывания и процесс релизов.

**Вопросы:**
1) Где будем размещать (облако/он‑прем)?
2) Какой цикл релизов допустим (раз в 2 недели, раз в месяц)?

## 12. Дорожная карта и риски
**Что делаем:**
- описываем этапы (МВП, расширение, масштабирование);
- фиксируем зависимости и риски;
- планируем меры снижения рисков.

**Результат:** дорожная карта и реестр рисков.

**Вопросы:**
1) Какие крайние сроки по запуску МВП?
2) Какие риски считаются критичными (интеграции, юрчасть, кадры)?

## 13. Ревью и валидация
**Что делаем:**
- проводим архитектурное ревью с бизнесом и техкомандой;
- делаем мини‑PoC для критичных интеграций.

**Результат:** согласованная архитектура и план валидации.

**Вопросы:**
1) Кто финально утверждает архитектуру (роль/имя)?
2) Какие интеграции нужно проверить в первую очередь?

---

## Минимальный набор артефактов
- HLA (актуализированная версия)
- диаграммы С4: контекст, контейнеры, компоненты
- BPMN/статусные диаграммы по ключевым сценариям
- словарь данных и ER‑модель
- спецификация АПИ и интеграций
- модель безопасности и РБАК
- матрица НФТ и план наблюдаемости
- дорожная карта с этапами и зависимостями

## Ближайшие следующие шаги
1) Утвердить список сценариев МВП (включая оба тендера).
2) Сделать доменную модель и словарь терминов.
3) Подготовить контекстную и контейнерную диаграммы.
